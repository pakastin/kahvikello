<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Coffee Time</title>
    <!-- Bulma CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma/css/bulma.min.css"
    >
    <style>
      .history-item {
        cursor: pointer;
      }
      .history-item:hover {
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <!-- App -->
    <section id="app" class="section m-5"></section>

    <!-- ReDOM -->
    <script src="https://redom.js.org/redom.min.js"></script>
    <script>
      // Destructure functions
      const { el, mount, setChildren, list, text, setAttr } = redom;

      /* Utility functions */
      function datetimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      function humanDate(date) {
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
      }

      function calculateRemainingCaffeine(history, currentDate) {
        let total = 0;
        history.forEach(dateStr => {
          const doseDate = new Date(dateStr);
          const diffHours = (currentDate - doseDate) / (1000 * 60 * 60);
          if (diffHours >= 0) {
            total += 100 * Math.pow(0.5, diffHours / 5);
          }
        });
        return Math.round(total);
      }

      function humanCaffeine(caffeine) {
        const rounded = Math.round(caffeine / 10) / 10;
        if (rounded) {
          return `Your body now has the same amount of caffeine as about ${rounded} cups of coffee.`;
        } else {
          return 'There is no more caffeine in the body.';
        }
      }

      // App state
      let historyData = JSON.parse(localStorage.getItem('history') || '[]');

      /* Create elements */

      // Header
      const header = el('header', { class: 'mb-5' }, [
        el('h1.title', 'Coffee Time'),
        el('p.subtitle', 'Enter the coffee portions to enjoy here, and you will see how much caffeine there is in the body. You can delete a dose by clicking on it.')
      ]);

      // Form
      const form = el(
        'form',
        { class: 'field has-addons' },
        [
          el('div.control', [
            el('input.input', {
              type: 'datetime-local',
              value: datetimeLocal(new Date()),
              required: true
            })
          ]),
          el('div.control', [
            el('button.button.is-primary', { type: 'submit' }, '☕️')
          ])
        ]
      );

      // Result
      const result = el('p', { class: 'mt-4' });

      // History title
      const historyTitle = el('p.title.is-5', { style: 'display: none;' }, 'Enjoyed cups:');

      // History list
      const historyList = el('ul', { class: 'list' }, []);

      // Delete all
      const removeAllButton = el(
        'button.button.is-danger.remove-all-btn.mt-5.has-text-light',
        { style: 'display: none;' },
        'Delete All'
      );

      // Container
      const container = el('div.container', [
        header,
        form,
        result,
        historyTitle,
        historyList,
        removeAllButton
      ]);

      // Mount App
      mount(document.getElementById('app'), container);

      // Update the result
      function updateResult() {
        const caffeine = calculateRemainingCaffeine(historyData, new Date());
        result.textContent = humanCaffeine(caffeine);
      }

      // Update history
      function updateHistory(data) {
        historyData = data;
        // Sort in descending
        const sorted = [...historyData].map(date => new Date(date)).sort((a, b) => b - a);

        if (sorted.length) {
          historyTitle.style.display = '';
          removeAllButton.style.display = '';
          updateResult();
        } else {
          historyTitle.style.display = 'none';
          removeAllButton.style.display = 'none';
          result.textContent = '';
        }

        // Update history
        setChildren(historyList, sorted.map(date => {
          const listItem = el('li.box.history-item.is-flex.is-justify-content-space-between.is-align-items-center', [
            el('span', humanDate(date)),
            el('button.delete.is-large', {
              onclick: () => {
                const updatedHistory = historyData.filter(
                  item => datetimeLocal(new Date(item)) !== datetimeLocal(date)
                );
                localStorage.setItem('history', JSON.stringify(updatedHistory));
                updateHistory(updatedHistory);
              }
            })
          ]);

          return listItem;
        }));
      }

      // Initial history
      updateHistory(historyData);

      // Submission handler
      form.onsubmit = event => {
        event.preventDefault();
        const input = form.querySelector('input[type="datetime-local"]');
        const date = new Date(input.value);

        if (isNaN(date.getTime())) {
          alert('Please enter a valid date and time.');
          return;
        }

        if (date > new Date()) {
          alert('The date cannot be in the future');
          return;
        }

        historyData.push(date.toISOString());
        localStorage.setItem('history', JSON.stringify(historyData));
        updateHistory(historyData);
        input.value = datetimeLocal(new Date());
      };

      // Remove all handler
      removeAllButton.onclick = () => {
        if (confirm('Are you sure you want to delete all entries ?')) {
          localStorage.removeItem('history');
          updateHistory([]);
        }
      };
    </script>
  </body>
</html>
